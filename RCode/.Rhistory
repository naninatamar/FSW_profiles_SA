pivot_wider(names_from = quantile, values_from = value) %>%
bind_cols(year = year_duration) %>%
rename(rate_Q0025 = Q0025,
rate_Q05 = Q05,
rate_Q0975 = Q0975)
pred.rate.re.rds = sim.dur.rds[, c("theta_mu","theta_tau","gamma")] %>%
rowwise() %>%
mutate(theta = rnorm(1, theta_mu , theta_tau)) %>% select(theta, gamma) %>% as.matrix() %*%
t(as.matrix(data.new.duration)) %>%
as_tibble() %>%
mutate_all(exp) %>%
summarise_all(list(Q0025 = ~ quantile(., probs = 0.025), Q05 = median, Q0975 = ~quantile(., probs = 0.975))) %>%
pivot_longer(cols = everything()) %>%
mutate(quantile = gsub(".*\\_", "", name)) %>%
mutate(name = gsub("\\_.*", "", name)) %>%
pivot_wider(names_from = quantile, values_from = value) %>%
bind_cols(year = year_duration) %>%
rename(rate_Q0025_re = Q0025,
rate_Q05_re = Q05,
rate_Q0975_re = Q0975)
pred.rate.tot.rds = pred.rate.rds %>%
left_join(pred.rate.re.rds)
### posterior predictions for each study:
r_lambda.rds = sim.dur.rds %>% select(starts_with("lambda["))
r_lambda_mean.rds = apply(X =r_lambda.rds,
MARGIN = 2,
FUN = mean)
r_lambda_sd.rds = apply(X = r_lambda.rds,
MARGIN = 2,
FUN = sd)
r_lambda_quant.rds  = apply(X = r_lambda.rds,
MARGIN = 2,
FUN = quantile,
probs = c(0.025, 0.5, 0.975))
r_lambda_quant.rds = data.frame(t(r_lambda_quant.rds))
names(r_lambda_quant.rds) = c("Q2.5", "Q50", "Q97.5")
r_lambda_df.rds = data.frame(r_lambda_mean.rds, r_lambda_sd.rds, r_lambda_quant.rds)
r_lambda_df.rds$study_year = data.duration$study_year
r_lambda.rds = sim.dur.rds %>% select(starts_with("lambda["))
r_dur.rds = 1/r_lambda.rds
r_dur_mean.rds = apply(X =r_dur.rds,
MARGIN = 2,
FUN = mean)
r_dur_sd.rds = apply(X = r_dur.rds,
MARGIN = 2,
FUN = sd)
r_dur_quant.rds  = apply(X = r_dur.rds,
MARGIN = 2,
FUN = quantile,
probs = c(0.025, 0.5, 0.975))
r_dur_quant.rds = data.frame(t(r_dur_quant.rds))
names(r_dur_quant.rds) = c("Q2.5", "Q50", "Q97.5")
r_dur_df.rds = data.frame(r_dur_mean.rds, r_dur_sd.rds, r_dur_quant.rds)
r_dur_df.rds$study_year = data.duration$study_year
### Plots:
###########
# Plot posterior predictions of expected FSW age
(plot.age.rds = pred.tot.age.rds %>%
ggplot(aes(x=year, y = Q05)) +
geom_line(col = "tomato", size = 0.8)+
geom_ribbon(aes(ymin = Q0025, ymax = Q0975),
alpha = 0.3, fill = "tomato") +
theme_bw() +
labs(y = "Mean age (95% CrI) of female sex workers [years]", x = "Study year") +
geom_point(data = data.age,
aes(y = mean_age_adjusted_rds, x = study_year, size = studysize_age),
col = "black") +
geom_ribbon(data = pred.tot.age.rds,
aes(ymin = Q0025_re, ymax = Q0975_re),
alpha = 0.2, fill = "tomato") +
theme(legend.position = "none")  +
scale_y_continuous(breaks = c(24,26,28,30, 32, 34, 36, 38)) +
scale_x_continuous(breaks = c(1996, 2000,2005, 2010, 2015, 2019)) +
geom_pointrange(data = age_df.rds,
aes(y = Q50,  ymin = Q2.5, ymax = Q97.5, x = year),
position = position_jitter(width = 0.2, height = 0),
col = "gray40", alpha = 0.6) +
scale_size_continuous(range= c(0.1,5))
)  #
# plot posterior prediction of expected SW duration:
(plot.dur.rds  = pred.rate.tot.rds %>%
ggplot(aes(x=year, y = rate_Q05)) +
geom_line(col = "dodgerblue", size = 0.8)+
geom_ribbon(aes(ymin = rate_Q0025, ymax = rate_Q0975), alpha = 0.3, fill = "dodgerblue") +
theme_bw() +
labs(y = "Mean duration (95%-CrI) of sex work [years]", x = "Study year") +
scale_x_continuous(breaks = c(1996, 2000, 2005, 2010, 2015, 2019)) +
geom_ribbon(aes(ymin = rate_Q0025_re, ymax = rate_Q0975_re), alpha = 0.2, fill = "dodgerblue") +
geom_point(data = data.duration, aes(y = mean_duration_adjusted_rds, x = study_year, size = studysize_duration), col = "black") +
theme(legend.position = "none") +
scale_size_continuous(range = c(0.5, 5)) +
scale_y_continuous(breaks =c(2.5, 5, 7.5, 10, 12.5 ,15, 17.5)) +
geom_pointrange(data = r_dur_df.rds,
aes(y = Q50,  ymin = Q2.5, ymax = Q97.5, x = study_year),
position = position_jitter(width = 0.2, height = 0),
col = "gray40",
alpha = 0.6))
cowplot::plot_grid(plot.age, plot.age.rds)
cowplot::plot_grid(plot.dur, plot.dur.rds)
save(pred.tot.age, pred.tot.age_noslope, pred.rate.tot,pred.rate.tot.noslope,  b.tot.sum,pred.sens.tot,  age_quant.indiv, dur_quant.indiv, data.sens.small, pred.sens.tot.pred,
file = "../../RData/posterior_predictions.rda")
save(plot.dur, plot.rate.lamba, plot.age.plot.sd, gprandom, file = "../../RData/plots_main_analysis.rds" )
save(plot.dur, plot.rate.lamba, plot.age, plot.sd, gprandom, file = "../../RData/plots_main_analysis.rds" )
plot.age.indiv
plot.age.exclMilo
plot.dur.exclMilo
save(plot.sens, plot.age.exclMilo, plot.dur.exclMilo, file = "../../RData/plots_sensitivity_analysis.rda")
# load libraries
library(tidyverse)
require(readxl)
# source
source("01_data_adjustment.R")
# load model outputs
load("../../RData/age_model_fit.rda")
load("../../RData/duration_model_fit.rda")
load("../../RData/model_fits_noslope.rda")
fsw_prev = read_excel("../../Thembisa_data/fsw_prev_thembisa.xlsx", sheet = 2) %>%
select(Prevalence | starts_with("19") | starts_with("20")) %>%
pivot_longer(cols = 2:47) %>%
pivot_wider(values_from = value, names_from = Prevalence) # first column contains year, second Thembisa's estimated Mean, 3rd 95% LL and 4th 95% UL (LL and UL not used in this exercise)
## Load estimates of annual age-specific HIV prevalence in females from Thembisa model (can be found on the Thembisa webpage)
f_prev_age_orig <- read_excel("../../Thembisa_data/f_prev_age.xlsx", sheet = 2) %>%
as_tibble() %>%
pivot_longer(cols = 2:47, values_to = "prevalence", names_to = "year") # First column contains Age-zear, second calendar year, 3rd mean prevalence (from Thembisa)
f_prev_by_age_year = f_prev_age_orig %>%
mutate(year = as.numeric(year)) %>%
mutate(Age = ifelse(Age == "90+", "90", Age)) %>% # to make ages numeric transform 90+ into 90
mutate(Age = as.numeric(Age)) %>%
mutate(p_agelwr_ylwr = prevalence) %>% # for linear interpolation: p_agelwr_ylwr contains the prevalence in age a (as reported in first column) and year y (as reported in second column)
group_by(year) %>%
arrange(Age, .by_group = TRUE) %>%
mutate(p_ageupr_ylwr = lead(prevalence)) %>%  # for linear interpolation: p_ageupr_ylwr = prevalence in age a+1 and year y
group_by(Age) %>%
arrange(year, .by_group = TRUE) %>%
mutate(p_agelwr_yupr = lead(prevalence)) # for linear interpolation: p_agelwr_yupr = prevalence in age a and year y+1
data.prev.temp = f_prev_age_orig %>%
mutate(year = as.numeric(year)) %>%
mutate(Age = ifelse(Age == "90+", "90", Age)) %>%
mutate(Age = as.numeric(Age)) %>%
mutate(Age = Age -1,
year = year - 1) %>%
rename(p_ageupr_yupr = prevalence) # for linear interpolation: p_ageupr_yupr = prevalence in age a+1 and year y+1
f_prev_by_age_year = f_prev_by_age_year %>%
left_join(data.prev.temp)
sim.fit.age = as.matrix(fit.age) %>%
as_tibble()
cutoff = 10
year = c(min(year_age)-0.25, year_age, max(year_age) + 0.25)
year_centred = year - mean(data.age$study_year)
data.new.age = data.frame(intercept = rep(1, length(year)), year_centered = year_centred)
age.long_re = sim.fit.age[, c("eta_mu","omega","eta_tau")] %>%
rowwise() %>%
mutate(eta = rnorm(1, eta_mu , eta_tau)) %>% select(eta, omega) %>% as.matrix() %*%
t(as.matrix(data.new.age)) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate_all(., function(x){x+cutoff}) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(age_linpred_re = value)
age.long = as.matrix(sim.fit.age[, c("eta_mu","omega")]) %*%
t(as.matrix(data.new.age)) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate_all(., function(x){x+cutoff}) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(age_linpred = value)
age.long = age.long %>% left_join(age.long_re)
age.long = age.long %>%
mutate(Age = floor(age_linpred),
year = floor(study_year)) %>%
mutate(diffyear = study_year - year,
diffage = age_linpred - Age)
age.long = age.long %>%
left_join(f_prev_by_age_year) # merge posterior predictions of expected age to age-specific HIV prevalence in general female population
age.long = age.long %>% # make linear interpolation between integer calendar and age years
mutate(p_agelwr_y = p_agelwr_ylwr + diffyear*(p_agelwr_yupr - p_agelwr_ylwr)) %>%
mutate(p_ageupr_y = p_ageupr_ylwr + diffyear*(p_ageupr_yupr - p_ageupr_ylwr)) %>%
mutate(p_age_y = p_agelwr_y + diffage*(p_ageupr_y - p_agelwr_y))
age.long = age.long %>%
select(imp, study_year, age_linpred, age_linpred_re, p0_linpred = p_age_y)
age.long = age.long %>%
mutate(study_year = as.numeric(study_year)) %>%
mutate(Age = floor(age_linpred_re),
year = floor(study_year)) %>%
mutate(diffyear = study_year - year,
diffage = age_linpred_re - Age)
age.long = age.long %>%
left_join(f_prev_by_age_year)
age.long = age.long %>%
mutate(p_agelwr_y = p_agelwr_ylwr + diffyear*(p_agelwr_yupr - p_agelwr_ylwr)) %>%
mutate(p_ageupr_y = p_ageupr_ylwr + diffyear*(p_ageupr_yupr - p_ageupr_ylwr)) %>%
mutate(p_age_y = p_agelwr_y + diffage*(p_ageupr_y - p_agelwr_y))
p0.long = age.long %>%
select(imp, study_year, age_linpred, age_linpred_re, p0_linpred, p0_pred = p_age_y) # p0_llinpred is based on age predictions on pop-mean level (excluding random effects variation), while p0_pred includes random effects variation (not used in the end)
year_centred_dur = year - mean(data.duration$study_year)
data.new.dur = data.frame(intercept = rep(1, length(year)), year_centered = year_centred_dur)
sim.dur = as.matrix(fit.duration) %>%
as_tibble()
mu.long = as.matrix(sim.dur[, c("theta_mu", "gamma")]) %*%
t(as.matrix(data.new.dur)) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(mu_linpred = value)
mu.long.re = sim.dur[, c("theta_mu","theta_tau","gamma")] %>%
rowwise() %>%
mutate(theta = rnorm(1, theta_mu , theta_tau)) %>% select(theta, gamma) %>% as.matrix() %*%
t(as.matrix(data.new.dur)) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(mu_linpred_re = value)
mu.long = mu.long %>%
left_join(mu.long.re)
mu.long = mu.long %>%
mutate(study_year = as.numeric(study_year))
fsw.prev.temp = fsw_prev %>%
mutate(year = as.numeric(name),
fswprev = Mean) %>%
select(year, fswprev) %>%
arrange(year) %>%
mutate(fswprev_lead = lead(fswprev)) %>%
mutate(diff_fswprev = fswprev_lead - fswprev) %>%
mutate(diff_fswprevlag = lag(diff_fswprev)) %>%
mutate(dpoverdt = (diff_fswprev + diff_fswprevlag)/2) %>%
mutate(dpoverdt_lead = lead(dpoverdt)) %>%
mutate(diff_dpoverdt = dpoverdt_lead - dpoverdt)
p.long = data.frame(study_year = year) %>%
mutate(year = floor(study_year)) %>%
mutate(diffyear = study_year - year) %>%
left_join(fsw.prev.temp) %>%
mutate(fsw_prev_linexp = fswprev + diffyear*diff_fswprev) %>%
mutate(dpoverdt_linexp = dpoverdt + diffyear*diff_dpoverdt) %>%
select(study_year, p_base = fswprev, p_linexp = fsw_prev_linexp, dpoverdt_linexp)
## merge all data needed (P0, P, SW duration/rate of leaving SW)
data.sim = p0.long %>% left_join(mu.long) %>% left_join(p.long)
# calculated the HIV incidence rate in FSW rho(t):
data.sim = data.sim %>%
mutate(rho_linpred_re = (dpoverdt_linexp + 1/mu_linpred_re*(p_linexp - p0_pred))/(1-p_linexp),
rho_linpred = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred))/(1-p_linexp))
data.sim.r1 = data.sim %>% # plot assuming r = 1 (HIV prevalence at entry into SW equals (r=1) HIV prevalence in general female population of same age)
filter(study_year >= 1996, study_year <= 2019) %>%
group_by(study_year) %>%
summarise(rho_med = median(rho_linpred),
rho_lwr = quantile(rho_linpred, 0.05),
rho_upr = quantile(rho_linpred, 0.95),
rho_lwr_re = quantile(rho_linpred_re, 0.05),
rho_upr_re = quantile(rho_linpred_re, 0.95))
data.sim.different.r = data.sim %>% # construct data with r = 1.25, 1.5, 1.75, 2
mutate(p0_linpred_a = 1.25*p0_linpred,
p0_linpred_b = 1.5*p0_linpred,
p0_linpred_c = 1.75*p0_linpred,
p0_linpred_d = 2*p0_linpred) %>%
mutate(rho_linpred_a = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_a))/(1-p_linexp),
rho_linpred_b = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_b))/(1-p_linexp),
rho_linpred_c = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_c))/(1-p_linexp),
rho_linpred_d = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_d)/(1-p_linexp)))
data.sim.different.r = data.sim.different.r %>%
group_by(study_year) %>%
summarise(rho_med_0 = median(rho_linpred),
rho_lwr_0 = quantile(rho_linpred, 0.05),
rho_upr_0 = quantile(rho_linpred, 0.95),
rho_med_a = median(rho_linpred_a),
rho_lwr_a = quantile(rho_linpred_a, 0.05),
rho_upr_a = quantile(rho_linpred_a, 0.95),
rho_med_b = median(rho_linpred_b),
rho_lwr_b = quantile(rho_linpred_b, 0.05),
rho_upr_b = quantile(rho_linpred_b, 0.95),
rho_med_c = median(rho_linpred_c),
rho_lwr_c = quantile(rho_linpred_c, 0.05),
rho_upr_c = quantile(rho_linpred_c, 0.95),
rho_med_d = median(rho_linpred_d),
rho_lwr_d = quantile(rho_linpred_d, 0.05),
rho_upr_d = quantile(rho_linpred_d, 0.95)) %>%
pivot_longer(cols = contains("rho")) %>%
mutate(estimate = str_sub(name, 5, 7)) %>%
mutate(f_p0 = str_sub(name, 9,9)) %>%
select(-name) %>%
pivot_wider(values_from = value, names_from = estimate) %>%
mutate(factor_increase = case_when(f_p0 == "0" ~ 1,
f_p0 == "a" ~ 1.25,
f_p0 == "b" ~ 1.5,
f_p0 == "c" ~ 1.75,
f_p0 == "d" ~ 2))
sim.fit.age.noslope = as.matrix(fit.age.noslope) %>%
as_tibble()
age.long_re_noslope = sim.fit.age.noslope[, c("eta_mu","eta_tau")] %>%
rowwise() %>%
mutate(eta = rnorm(1, eta_mu , eta_tau)) %>% select(eta) %>% as.matrix() %*%
t(as.matrix(data.new.age[,1])) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate_all(., function(x){x+10}) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(age_linpred_re = value)
age.long_noslope = as.matrix(sim.fit.age.noslope[, c("eta_mu")]) %*%
t(as.matrix(data.new.age[,1])) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate_all(., function(x){x+10}) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(age_linpred = value)
age.long_noslope = age.long_noslope %>% left_join(age.long_re_noslope)
age.long_noslope = age.long_noslope %>%
mutate(Age = floor(age_linpred),
year = floor(study_year)) %>%
mutate(diffyear = study_year - year,
diffage = age_linpred - Age)
age.long_noslope = age.long_noslope %>%
left_join(f_prev_by_age_year)
age.long_noslope = age.long_noslope %>%
mutate(p_agelwr_y = p_agelwr_ylwr + diffyear*(p_agelwr_yupr - p_agelwr_ylwr)) %>%
mutate(p_ageupr_y = p_ageupr_ylwr + diffyear*(p_ageupr_yupr - p_ageupr_ylwr)) %>%
mutate(p_age_y = p_agelwr_y + diffage*(p_ageupr_y - p_agelwr_y))
age.long_noslope = age.long_noslope %>%
select(imp, study_year, age_linpred, age_linpred_re, p0_linpred = p_age_y)
age.long_noslope = age.long_noslope %>%
mutate(study_year = as.numeric(study_year)) %>%
mutate(Age = floor(age_linpred_re),
year = floor(study_year)) %>%
mutate(diffyear = study_year - year,
diffage = age_linpred_re - Age)
age.long_noslope = age.long_noslope %>%
left_join(f_prev_by_age_year)
age.long_noslope = age.long_noslope %>%
mutate(p_agelwr_y = p_agelwr_ylwr + diffyear*(p_agelwr_yupr - p_agelwr_ylwr)) %>%
mutate(p_ageupr_y = p_ageupr_ylwr + diffyear*(p_ageupr_yupr - p_ageupr_ylwr)) %>%
mutate(p_age_y = p_agelwr_y + diffage*(p_ageupr_y - p_agelwr_y))
p0.long_noslope = age.long_noslope %>%
select(imp, study_year, age_linpred, age_linpred_re, p0_linpred, p0_pred = p_age_y)
sim.dur_noslope = as.matrix(fit.duration.noslope) %>%
as_tibble()
mu.long_noslope = as.matrix(sim.dur_noslope[, c("theta_mu")]) %*%
t(as.matrix(data.new.dur[,1])) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(mu_linpred = value)
mu.long.re_noslope = sim.dur_noslope[, c("theta_mu","theta_tau")] %>%
rowwise() %>%
mutate(theta = rnorm(1, theta_mu , theta_tau)) %>% select(theta) %>% as.matrix() %*%
t(as.matrix(data.new.dur[,1])) %>%
as_tibble() %>%
mutate_all(exp) %>%
mutate(imp  = row_number()) %>%
pivot_longer(cols = 1:(93+2)) %>%
bind_cols(study_year = rep(year, 8000)) %>%
rename(mu_linpred_re = value)
mu.long_noslope = mu.long_noslope %>%
left_join(mu.long.re_noslope)
mu.long_noslope = mu.long_noslope %>%
mutate(study_year = as.numeric(study_year))
## combine all data togeterh (P0, P, and duration of SW/rate of leaving SW)
data.sim_noslope = p0.long_noslope %>% left_join(mu.long_noslope) %>% left_join(p.long)
data.sim_noslope = data.sim_noslope %>%
mutate(rho_linpred_re = (dpoverdt_linexp + 1/mu_linpred_re*(p_linexp - p0_pred))/(1-p_linexp),
rho_linpred = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred))/(1-p_linexp))
data.sim.r1_noslope = data.sim_noslope %>%
filter(study_year >= 1996, study_year <= 2019) %>%
group_by(study_year) %>%
summarise(rho_med = median(rho_linpred),
rho_lwr = quantile(rho_linpred, 0.05),
rho_upr = quantile(rho_linpred, 0.95),
rho_lwr_re = quantile(rho_linpred_re, 0.05),
rho_upr_re = quantile(rho_linpred_re, 0.95))
data.sim.different.r_noslope = data.sim_noslope %>%
mutate(p0_linpred_a = 1.25*p0_linpred,
p0_linpred_b = 1.5*p0_linpred,
p0_linpred_c = 1.75*p0_linpred,
p0_linpred_d = 2*p0_linpred) %>%
mutate(rho_linpred_a = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_a))/(1-p_linexp),
rho_linpred_b = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_b))/(1-p_linexp),
rho_linpred_c = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_c))/(1-p_linexp),
rho_linpred_d = (dpoverdt_linexp + 1/mu_linpred*(p_linexp - p0_linpred_d)/(1-p_linexp)))
data.sim.different.r_noslope = data.sim.different.r_noslope %>%
group_by(study_year) %>%
summarise(rho_med_0 = median(rho_linpred),
rho_lwr_0 = quantile(rho_linpred, 0.05),
rho_upr_0 = quantile(rho_linpred, 0.95),
rho_med_a = median(rho_linpred_a),
rho_lwr_a = quantile(rho_linpred_a, 0.05),
rho_upr_a = quantile(rho_linpred_a, 0.95),
rho_med_b = median(rho_linpred_b),
rho_lwr_b = quantile(rho_linpred_b, 0.05),
rho_upr_b = quantile(rho_linpred_b, 0.95),
rho_med_c = median(rho_linpred_c),
rho_lwr_c = quantile(rho_linpred_c, 0.05),
rho_upr_c = quantile(rho_linpred_c, 0.95),
rho_med_d = median(rho_linpred_d),
rho_lwr_d = quantile(rho_linpred_d, 0.05),
rho_upr_d = quantile(rho_linpred_d, 0.95)) %>%
pivot_longer(cols = contains("rho")) %>%
mutate(estimate = str_sub(name, 5, 7)) %>%
mutate(f_p0 = str_sub(name, 9,9)) %>%
select(-name) %>%
pivot_wider(values_from = value, names_from = estimate) %>%
mutate(factor_increase = case_when(f_p0 == "0" ~ 1,
f_p0 == "a" ~ 1.25,
f_p0 == "b" ~ 1.5,
f_p0 == "c" ~ 1.75,
f_p0 == "d" ~ 2))
(plot_sim_r1 = data.sim.r1  %>%
mutate(type = "time trend") %>%
mutate(fac = "r = 1") %>%
ggplot(aes(x=study_year, y=rho_med, group = type)) +
geom_line(data = data.sim.r1_noslope %>% mutate(type = "constant") %>%  mutate(fac = "r = 1"),
aes(linetype = type, col = type), size = 0.6) +
geom_ribbon(data = data.sim.r1_noslope %>% mutate(type = "constant") %>%  mutate(fac = "r = 1"),
aes(ymin = rho_lwr, ymax = rho_upr, col = type, fill = type),
alpha = 0.2, linetype = 2) +
geom_line(aes(col = type, linetype = type), size = 0.6) +
geom_ribbon(aes(ymin = rho_lwr, ymax = rho_upr, fill = type, col = type, linetype = type),
linetype = 1,  alpha = 0.5) +
theme_bw() +
labs(y=expression(paste("HIV incidence rate ", rho, " in female sex workers")),
x = "Calendar year") +
scale_color_manual(values =(c("gray40", "seagreen"))) +
scale_fill_manual(values =(c("gray40", "seagreen"))) +
guides(fill = FALSE, col = FALSE) +
facet_wrap(vars(fac)) +
scale_linetype_manual(values = c(1,2), name = NULL, breaks = c("time trend", "constant"),
labels = c("time trends in FSW age & SW duration ", "constant FSW age & SW duration")) +
scale_x_continuous(breaks = c(1990, 1996, 2000, 2005, 2010, 2015,2019)) +
theme(legend.position = "bottom") +
# coord_cartesian(ylim = c(0.01,0.35)))
coord_cartesian(ylim = c(0.01,0.47)))
fakedata = data.frame(y = c(0.5, 0.5), ymin = c(0.55, 0.55),
ymax = c(0.65, 0.65), x = c(2000, 2010), fact = "r = 1.25",
type = "time trend", factor_increase = 1)
(plot_sim_r1.25_to_1.75 = data.sim.different.r %>%
filter(study_year >= 1996, study_year <= 2019) %>%
mutate(type = "time trend") %>%
mutate(fact = factor(as.character(factor_increase),
labels = c("r = 1", "r = 1.25", "r = 1.5", "r = 1.75", "r = 2"))) %>%
filter(!factor_increase %in% c(1,2)) %>%
ggplot(aes(x=study_year, y=med, group = type)) +
geom_line(data = data.sim.different.r_noslope %>% filter(!factor_increase %in% c(1,2)) %>%
filter(study_year >= 1996, study_year <= 2019) %>%
mutate(type = "constant",
fact =factor(as.character(factor_increase),
labels = c("r = 1.25", "r = 1.5", "r = 1.75"))),
col = "gray40", lty = 2) +
geom_ribbon(data = data.sim.different.r_noslope %>% filter(!factor_increase %in% c(1,2)) %>%
filter(study_year >= 1996, study_year <= 2019) %>%
mutate(type = "constant",
fact = factor(as.character(factor_increase),
labels = c("r = 1.25", "r = 1.5", "r = 1.75"))),
aes(ymin = lwr, ymax = upr),fill = "gray40",col = "gray40",alpha = 0.2, lty=2) +
geom_line(aes(col = factor_increase)) +
geom_ribbon(aes(ymin = lwr, ymax = upr, fill = factor_increase, col = factor_increase),alpha = 0.5) +
geom_line(data = fakedata, aes(y = y, x = x, col = factor_increase)) +
geom_ribbon(data = fakedata, aes(ymin = ymin,ymax = ymax, y=y, x = x, fill = factor_increase), alpha = 0.5) +
theme_bw() +
labs(y=expression(paste("HIV incidence rate ", rho, " in female sex workers")),
x = "Calendar year",
fill = "Assumed ratio r of HIV prevalence in FSW at entry\ninto sex work compared to general female population",
col =  "Assumed ratio r of HIV prevalence in FSW at entry\ninto sex work compared to general female population") +
scale_fill_gradient(high = "chartreuse", low = "seagreen", breaks = c(1.0, 1.25, 1.5, 1.75), labels  = c("1", "1.25", "1.5", "1.75")) +
scale_color_gradient(high = "chartreuse", low = "seagreen", breaks = c(1.0, 1.25, 1.5, 1.75),
labels  = c("1", "1.25", "1.5", "1.75")) +
facet_wrap(vars(fact)) +
scale_x_continuous(breaks = c(1990, 1996, 2000, 2005, 2010, 2015,2019)) +
theme(legend.position = "bottom",
legend.margin=margin(0,0,0,0),
legend.box.margin=margin(-10,0,0,0),
axis.text.x = element_text(angle = 45, hjust = 1)) +
coord_cartesian(ylim = c(0.01,0.47)) + theme(legend.position = "top"))
cowplot::plot_grid(plot_sim_r1, plot_sim_r1.25_to_1.75, nrow = 2,
rel_heights = c(0.6, 0.4), labels = LETTERS)
save(plot_sim_r1, plot_sim_r1.25_to_1.75,
file = "../../RData/plots_simulation_exercise.rda")
plot_slopes
plot_intercepts
save(plot_slopes, plot_intercepts, file = "../../RData/plots_slopesintercepts.rda")
plot.age.indiv
plot.dur.indiv
save(plot.age.indiv, plot.dur.indiv, file = "../../RData/plots_individual_level.rda")
plot.age.constant
plot.duration.constant
save(plot.age.constant, plot.duration.constant, file = "../../plots_constant_FSWprofiles.rda")
save(plot.age.constant, plot.duration.constant, file = "../../RData/plots_constant_FSWprofiles.rda")
setwd("~/pCloudDrive/CapeTown/UCT/projects/KeyPop/Other_indicators/Stan_hierarchical_models/Github/FSW_profiles_SA/RCode")
mort.fsw = read_excel("../../Thembisa_data/FSW_AIDSmortality.xlsx", sheet = 4) %>%
pivot_longer(cols = c(2:32), names_to = "Year", values_to = "mort") %>%
rename("statistic" = "...1") %>%
pivot_wider(names_from = statistic, values_from = mort) %>%
rename("lb" = "95% LL", "ub" = "95% UL") %>%
mutate(Year = as.numeric(Year))
(plot.mortatliy_thembisa  = mort.fsw %>%
filter(Year >= 1996, Year <= 2019) %>%
ggplot(aes(x = Year, y = Average)) +
geom_line(col = "orange") +
geom_ribbon(aes(ymin = lb, ymax = ub), alpha = 0.4, fill = "orange") +
theme_bw() +
labs(y = "AIDS-mortality rates (95% CrI) in FSW [per person-year]") +
scale_y_continuous(limits= c(0, 0.02)))
save(plot.mortatliy_thembisa, file = "../../Rdata/Final/plot_thembisa_mortality.rda")
save(plot.mortatliy_thembisa, file = "../../RData/plot_thembisa_mortality.rda")
